name: Deploy to GitHub Pages test

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging or production). If empty, branch is used (main => production, others => staging).'
        required: false
        default: ''

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm ci

      - name: Set environment variables
        # Determine target environment (workflow input > branch). Write
        # ENVIRONMENT, TEST_ENV_VARIABLE (from secrets) and VITE_BASE to
        # $GITHUB_ENV so they are available to subsequent steps.
        run: |
          # Determine env from workflow_dispatch input if provided
          if [ -n "${{ github.event.inputs.environment }}" ]; then
            env_choice="${{ github.event.inputs.environment }}"
          else
            branch="${GITHUB_REF#refs/heads/}"
            if [ "$branch" = "main" ]; then
              env_choice=production
            else
              env_choice=staging
            fi
          fi

          echo "ENVIRONMENT=$env_choice" >> $GITHUB_ENV

          # Map TEST_ENV_VARIABLE from variables depending on environment.
          if [ "$env_choice" = "production" ]; then
            echo "TEST_ENV_VARIABLE=${{ variables.TEST_ENV_VARIABLE }}" >> $GITHUB_ENV
          else
            echo "TEST_ENV_VARIABLE=${{ variables.TEST_ENV_VARIABLE }}" >> $GITHUB_ENV
          fi

          # Compute VITE_BASE (same logic as before)
          repo="${GITHUB_REPOSITORY##*/}"
          if [[ "$repo" == *.github.io ]]; then
            echo "VITE_BASE=/" >> $GITHUB_ENV
          else
            echo "VITE_BASE=/$repo/" >> $GITHUB_ENV
          fi

      - name: Show computed values
        run: |
          echo "ENVIRONMENT=$ENVIRONMENT"
          echo "VITE_BASE=$VITE_BASE"

      - name: Build
        # VITE_BASE and TEST_ENV_VARIABLE (set above) will be available in the
        # environment for this step and Vite will pick them up via
        # `vite.config.ts`.
        run: npm run build

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
